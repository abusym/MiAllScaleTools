# 旧代码参考（存档）

本文件用于存档旧版本“电子秤数据同步工具”的反编译源码，供后续对照业务规则与 SQL。  
对应原位置：`MiAllScaleTools/old source code`（已从工程中移除，避免被编译）。

## Good.cs

```csharp
// Decompiled with JetBrains decompiler
// Type: SyncScaleData.Models.Good
// Assembly: 秘奥电子秤数据同步工具, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: FD84282E-8527-4364-8E43-5FE642C4F7A1
// Assembly location: C:\Users\abusy\Desktop\秘奥电子秤数据同步工具.exe

#nullable disable
namespace SyncScaleData.Models;

public class Good
{
  public string Name { get; set; }

  public string Barcode { get; set; }

  public double Price { get; set; }

  public override string ToString() => $"名称：{this.Name}, 条码：{this.Barcode}，价格：{this.Price}";
}
```

## ScaleDataReader.cs

```csharp
// Decompiled with JetBrains decompiler
// Type: SyncScaleData.ScaleDataReader
// Assembly: 秘奥电子秤数据同步工具, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: FD84282E-8527-4364-8E43-5FE642C4F7A1
// Assembly location: C:\Users\abusy\Desktop\秘奥电子秤数据同步工具.exe

using SyncScaleData.Models;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.OleDb;
using System.IO;

#nullable disable
namespace SyncScaleData;

public class ScaleDataReader
{
  private static string DB_FILE = "mscale.mdb";

  public static List<Good> ReadData()
  {
    if (!File.Exists(ScaleDataReader.DB_FILE))
      throw new Exception(ScaleDataReader.DB_FILE + "文件未找到，请确保程序运行在电子秤配套软件目录下");
    try
    {
      using (OleDbConnection selectConnection = new OleDbConnection("Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" + ScaleDataReader.DB_FILE))
      {
        List<Good> goodList = new List<Good>();
        OleDbDataAdapter oleDbDataAdapter = new OleDbDataAdapter("select * from t_base_merchandise", selectConnection);
        DataTable dataTable = new DataTable();
        selectConnection.Open();
        oleDbDataAdapter.Fill(dataTable);
        foreach (DataRow row in (InternalDataCollectionBase) dataTable.Rows)
        {
          string str1 = row.Field<string>("mname1");
          double num = row.Field<double>("mprice");
          string str2 = row.Field<string>("mcode");
          if (string.IsNullOrWhiteSpace(str2) || str2.Length != 7)
            throw new Exception(str1 + "的条码位数必须等于7位");
          goodList.Add(new Good()
          {
            Name = str1,
            Price = num,
            Barcode = str2.Substring(2, 5)
          });
        }
        return goodList;
      }
    }
    catch (Exception ex)
    {
      throw ex;
    }
  }
}
```

## MiAllAdapter.cs（旧名：MiaoAdapter）

```csharp
// Decompiled with JetBrains decompiler
// Type: SyncScaleData.MiaoAdapter
// Assembly: 秘奥电子秤数据同步工具, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: FD84282E-8527-4364-8E43-5FE642C4F7A1
// Assembly location: C:\Users\abusy\Desktop\秘奥电子秤数据同步工具.exe

using SyncScaleData.Models;
using System;
using System.Collections.Generic;
using System.Data.SqlClient;
using System.Text;

#nullable disable
namespace SyncScaleData;

public class MiaoAdapter
{
  private const string CONN_STR = "Server=.;Database=MiDe5;Trusted_Connection=True;";
  private const string GOOD_TYPE_NAME = "099 生鲜（电子秤）";

  public static void updateGood(Good good)
  {
    string goodTypeNo = MiaoAdapter.GetGoodTypeNo();
    using (SqlConnection sqlConnection = new SqlConnection("Server=.;Database=MiDe5;Trusted_Connection=True;"))
    {
      sqlConnection.Open();
      SqlCommand command = sqlConnection.CreateCommand();
      command.CommandText = $"update jbgoods set srefprice={good.Price}, goodsname='{good.Name}' where barcode='{good.Barcode}' and goodstypeno='{goodTypeNo}'";
      if (command.ExecuteNonQuery() != 0)
        return;
      command.CommandText = "select max(cast(goodsno as int))+1 from jbgoods";
      string str = command.ExecuteScalar().ToString();
      command.CommandText = "insert into jbgoods(goodsno, goodscode, goodsname, goodstypeno, barcode, srefprice, salestype) " + $"values('{str}', '{str}', '{good.Name}', '{goodTypeNo}', '{good.Barcode}', {good.Price}, 0)";
      command.ExecuteNonQuery();
    }
  }

  public static int DeleteNoExistsProducts(List<Good> scaleGoods)
  {
    if (scaleGoods.Count == 0)
      return 0;
    string goodTypeNo = MiaoAdapter.GetGoodTypeNo();
    StringBuilder stringBuilder = new StringBuilder();
    stringBuilder.Append($"delete jbgoods where goodstypeno='{goodTypeNo}' and barcode in(");
    foreach (Good scaleGood in scaleGoods)
      stringBuilder.Append($"\"{scaleGood.Barcode}\", ");
    stringBuilder.Remove(stringBuilder.Length - 2, 2).Append(")");
    using (SqlConnection sqlConnection = new SqlConnection("Server=.;Database=MiDe5;Trusted_Connection=True;"))
    {
      sqlConnection.Open();
      SqlCommand command = sqlConnection.CreateCommand();
      command.CommandText = stringBuilder.ToString();
      return command.ExecuteNonQuery();
    }
  }

  private static string GetGoodTypeNo()
  {
    using (SqlConnection sqlConnection = new SqlConnection("Server=.;Database=MiDe5;Trusted_Connection=True;"))
    {
      sqlConnection.Open();
      SqlCommand command = sqlConnection.CreateCommand();
      command.CommandText = "select goodstypeno from jbgoodstype where goodstypename='099 生鲜（电子秤）'";
      string str = command.ExecuteScalar().ToString();
      return !string.IsNullOrWhiteSpace(str) ? str : throw new Exception("请在后台添加商品类目\"099 生鲜（电子秤）\"");
    }
  }
}
```

## From.cs（旧 UI：WinForms + MetroFramework）

```csharp
// Decompiled with JetBrains decompiler
// Type: ScaleDataSync.Form1
// Assembly: 秘奥电子秤数据同步工具, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: FD84282E-8527-4364-8E43-5FE642C4F7A1
// Assembly location: C:\Users\abusy\Desktop\秘奥电子秤数据同步工具.exe

using MetroFramework;
using MetroFramework.Controls;
using MetroFramework.Forms;
using SyncScaleData;
using SyncScaleData.Models;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Drawing;
using System.Threading;
using System.Windows.Forms;

#nullable disable
namespace ScaleDataSync;

public class Form1 : MetroForm
{
  private readonly BackgroundWorker worker = new BackgroundWorker();
  private IContainer components = (IContainer) null;
  private MetroButton RunButton;
  private MetroProgressBar progressBar;
  private Label label1;
  private Label progressLabel;

  public Form1()
  {
    this.InitializeComponent();
    Control.CheckForIllegalCrossThreadCalls = false;
    this.worker.WorkerReportsProgress = true;
    this.worker.DoWork += new DoWorkEventHandler(this.worker_DoWork);
    this.worker.RunWorkerCompleted += new RunWorkerCompletedEventHandler(this.worker_RunWorkerCompleted);
    this.worker.ProgressChanged += new ProgressChangedEventHandler(this.worker_ProgressChanged);
  }

  private void RunButton_Click(object sender, EventArgs e) => this.worker.RunWorkerAsync();

  private void worker_DoWork(object sender, DoWorkEventArgs e)
  {
    try
    {
      ((Control) this.RunButton).Enabled = false;
      ((Control) this.RunButton).Text = "正在执行";
      this.progressLabel.Text = "";
      this.worker.ReportProgress(0);
      List<Good> goodList = ScaleDataReader.ReadData();
      for (int index = 0; index < goodList.Count; ++index)
      {
        this.progressLabel.Text = "更新商品：" + goodList[index].Name;
        MiaoAdapter.updateGood(goodList[index]);
        this.worker.ReportProgress(100 - goodList.Count / (index + 1));
        Thread.Sleep(10);
      }
      this.worker.ReportProgress(100);
      this.progressLabel.Text = "同步完成";
    }
    catch (Exception ex)
    {
      this.progressLabel.Text = "同步期间发生异常";
      int num = (int) MessageBox.Show(ex.Message);
    }
  }

  private void worker_RunWorkerCompleted(object sender, RunWorkerCompletedEventArgs e)
  {
    ((Control) this.RunButton).Enabled = true;
    ((Control) this.RunButton).Text = "执行同步";
  }

  private void worker_ProgressChanged(object sender, ProgressChangedEventArgs e)
  {
    this.progressBar.Value = e.ProgressPercentage;
  }

  protected virtual void Dispose(bool disposing)
  {
    if (disposing && this.components != null)
      this.components.Dispose();
    base.Dispose(disposing);
  }

  private void InitializeComponent()
  {
    ComponentResourceManager componentResourceManager = new ComponentResourceManager(typeof (Form1));
    this.RunButton = new MetroButton();
    this.progressBar = new MetroProgressBar();
    this.label1 = new Label();
    this.progressLabel = new Label();
    ((Control) this).SuspendLayout();
    ((Control) this.RunButton).Location = new Point(27, 248);
    ((Control) this.RunButton).Name = "RunButton";
    ((Control) this.RunButton).Size = new Size(400, 40);
    ((Control) this.RunButton).TabIndex = 0;
    ((Control) this.RunButton).Text = "执行同步";
    this.RunButton.Theme = (MetroThemeStyle) 2;
    this.RunButton.UseSelectable = true;
    ((Control) this.RunButton).Click += new EventHandler(this.RunButton_Click);
    ((Control) this.progressBar).Location = new Point(27, 212);
    ((Control) this.progressBar).Name = "progressBar";
    ((Control) this.progressBar).Size = new Size(400, 30);
    ((Control) this.progressBar).TabIndex = 1;
    this.label1.Font = new Font("微软雅黑", 10f);
    this.label1.Location = new Point(23, 79);
    this.label1.Name = "label1";
    this.label1.Size = new Size(404, 111);
    this.label1.TabIndex = 3;
    this.label1.Text = "免责声明：\r\n        本软件为方便客户免费提供使用，并非秘奥软件一部分，对因本软件可能造成的损失不承担任何责任。使用前请做好数据备份。";
    this.progressLabel.Font = new Font("微软雅黑", 9f, FontStyle.Regular, GraphicsUnit.Point, (byte) 134);
    this.progressLabel.ForeColor = Color.DarkRed;
    this.progressLabel.Location = new Point(24, 190);
    this.progressLabel.Name = "progressLabel";
    this.progressLabel.Size = new Size(403, 19);
    this.progressLabel.TabIndex = 4;
    this.progressLabel.TextAlign = ContentAlignment.MiddleLeft;
    ((ContainerControl) this).AutoScaleDimensions = new SizeF(8f, 15f);
    ((ContainerControl) this).AutoScaleMode = AutoScaleMode.Font;
    ((Form) this).ClientSize = new Size(450, 305);
    ((Control) this).Controls.Add((Control) this.progressLabel);
    ((Control) this).Controls.Add((Control) this.label1);
    ((Control) this).Controls.Add((Control) this.progressBar);
    ((Control) this).Controls.Add((Control) this.RunButton);
    ((Form) this).Icon = (Icon) componentResourceManager.GetObject("$this.Icon");
    ((Form) this).MaximizeBox = false;
    ((Control) this).Name = nameof (Form1);
    this.Style = (MetroColorStyle) 13;
    ((Control) this).Text = "秘奥电子秤数据同步工具";
    this.Theme = (MetroThemeStyle) 0;
    ((Control) this).ResumeLayout(false);
  }
}
```


